<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />

    <title>Color Picker Layout</title>
    <meta name="description" content="Color Picker Layout" />
    <meta name="author" content="eip" />
    <style>
      body,
      button,
      input {
        font-family: -apple-system, blink, "Helvetica Neue", arial, sans-serif;
        font-size: 100%;
      }
    </style>
  </head>

  <body>
    <button id="test" disabled onClick="start(true)">Start Benchmark</button>
    <input id="clipped" type="checkbox" />
    <label for="clipped">Hide clipped colors</label>
    <div>
      <canvas id="color-space"></canvas>
    </div>
    <div>
      <p id="status"></p>
    </div>

    <script src="../js/color.js"></script>
    <script>
      const canvasSize = 420;
      const testButton = document.getElementById("test");
      const clippedCheckbox = document.getElementById("clipped");
      const colorSpace = document.getElementById("color-space");
      colorSpace.width = colorSpace.height = canvasSize;
      const colorSpaceCtx = colorSpace.getContext("2d");
      const status = document.getElementById("status");
      const l = { min: 0, max: 100 };
      const c = { min: 0, max: 132 };
      const h = { min: 0, max: 360 };

      const clippedPixel = new Uint8Array(new ArrayBuffer(4));
      const coloredPixel = new Uint8Array(new ArrayBuffer(4));
      clippedPixel.set([255, 0, 0, 0]);
      coloredPixel.set([0, 0, 0, 255]);
      const rgbColor = [0, 0, 0];
      const rgbColorClipped = [0, 0, 0, 0];

      const minChVal = -0.000005;
      const maxChVal = 1.000005;

      const { width: csWidth, height: csHeight } = colorSpace;
      const imgData = colorSpaceCtx.createImageData(csWidth, csHeight);

      let chroma = c.min;
      let step = 1;
      let firstFrameTime = 0;
      let frames = 0;
      let running = false;

      function renderColorSpace(zv) {
        const colorBuf = clippedCheckbox.checked ? rgbColorClipped : rgbColor;
        for (let x = 0; x < csWidth; x++) {
          const xv = h.min + (x * (h.max - h.min)) / csWidth;
          for (let y = 0; y < csHeight; y++) {
            const yv = l.min + (y * (l.max - l.min)) / csHeight;
            const idx = (x + y * csWidth) * 4;
            colorBuf[0] = yv;
            colorBuf[1] = zv;
            colorBuf[2] = xv;
            let pixel = clippedPixel;
            lch2sRGB(colorBuf);
            if (colorBuf[3] !== 1) {
              pixel = coloredPixel
              sRGBfloat2int(colorBuf, pixel);
            }
            imgData.data.set(pixel, idx);
          }
        }
        colorSpaceCtx.putImageData(imgData, 0, 0);
      }

      function start(pause) {
        if (pause === true) {
          running = !running;
          test.innerText = `${running ? "Stop" : "Start"} Benchmark`;
        }
        if (!firstFrameTime) {
          firstFrameTime = performance.now();
        } else {
          const thisFrameTime = performance.now();
          if (thisFrameTime - firstFrameTime < 500) {
            frames++;
          } else {
            fps = (1000 * frames) / (thisFrameTime - firstFrameTime);
            firstFrameTime = thisFrameTime;
            frames = 0;
            status.innerText = `FPS: ${fps.toFixed(1)}`;
          }
        }
        renderColorSpace(chroma);
        chroma += step;
        if (chroma <= c.min || chroma >= c.max) step = -step;
        if (running) window.requestAnimationFrame(start);
      }

      window.addEventListener("load", () => (testButton.disabled = false));
    </script>
  </body>
</html>
